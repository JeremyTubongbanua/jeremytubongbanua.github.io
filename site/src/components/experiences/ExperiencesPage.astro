---
import { type Experience, sortBys, orderBys } from '../../types/experience.ts';
import ExperiencesQuickSelect from './ExperiencesQuickSelect.astro';
import ExperiencesFilter from './ExperiencesFilter.astro';
import ExperiencesSort from './ExperiencesSort.astro';
import ExperiencesList from './ExperiencesList.astro';

interface Props {
  allExperiences: Experience[],
  allCategories: string[],
}

const { allExperiences, allCategories } = Astro.props;
---
<h3>Experiences</h3>
<ExperiencesQuickSelect/>
<ExperiencesFilter 
  allCategories={allCategories}
/>
<ExperiencesSort 
  sortBys={sortBys}
  orderBys={orderBys}
/>
<ExperiencesList 
  totalCount={allExperiences.length}
/>
<script 
  is:inline
  define:vars={{
    allExperiences,
    allCategories,
    sortBys,
    orderBys,
  }}
>
  const showAllButton = document.getElementById('experiences-quick-select-show-all-button');
  const defaultButton = document.getElementById('experiences-quick-select-default-button');
  const competitionsButton = document.getElementById('experiences-quick-select-competitions-button');
  const conferencesButton = document.getElementById('experiences-quick-select-conferences-button');
  const roboticsButton = document.getElementById('experiences-quick-select-robotics-button');

  const showHiddenCheckbox = document.getElementById('experiences-filter-show-hidden-checkbox');
  const allCategoryCheckboxes = document.querySelectorAll('.experiences-filter-category-checkbox');
  const sortBySelect = document.getElementById('experiences-sort-sort-by-select');
  const orderBySelect = document.getElementById('experiences-sort-order-by-select');
  const experiencesUl = document.getElementById('experiences-list-ul');
  const experiencesCountSpan = document.getElementById('experiences-list-count-span');

  const getCheckedValues = (checkboxNodeList) => {
    return Array.from(checkboxNodeList).filter((checkbox) => checkbox.checked).map((checkbox) => checkbox.value);
  }

  const updateURL = () => {
    const params = new URLSearchParams();

    if(showHiddenCheckbox.checked) {
      params.append('showHidden', 'true');
    }

    const selectedCategories = getCheckedValues(allCategoryCheckboxes);
    if(selectedCategories.length > 0) {
      params.append('categories', selectedCategories.join(','));
    }

    params.append('sortBy', sortBySelect.value);
    params.append('orderBy', orderBySelect.value);

    const newURL = params.toString()
    ? `${window.location.pathname}?${params.toString()}`
      : window.location.pathname;

    window.history.replaceState({}, '', newURL);
  }

  const loadFromURL = () => {
    const params = new URLSearchParams(window.location.search);

    showHiddenCheckbox.checked = params.get('showHidden') === 'true';

    const urlCategories = params.get('categories')?.split(',').filter(Boolean) || [];
    if(urlCategories.length > 0) {
      allCategoryCheckboxes.forEach((checkbox) => {
        checkbox.checked = urlCategories.includes(checkbox.value);
      });
    } else {
      allCategoryCheckboxes.forEach((checkbox) => checkbox.checked = true);
    }

    sortBySelect.value = params.get('sortBy') || sortBys[1];
    orderBySelect.value = params.get('orderBy') || orderBys[1];

    experiencesCountSpan.textContent = `${allExperiences.length}`;
  }

  const applyDefaults = () => {
    showHiddenCheckbox.checked = false;
    allCategoryCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
    });
    sortBySelect.value=sortBys[0]; // Title
    orderBySelect.value=orderBys[0]; // Ascending
    experiencesCountSpan.textContent = `${allExperiences.length}`;
  };

  const render = () => {
    const selectedCategories = getCheckedValues(allCategoryCheckboxes);
    const filteredExperiences = allExperiences.filter((experience) => {
      const shouldBeShown = !experience.frontmatter.hidden || showHiddenCheckbox.checked;
      if(!shouldBeShown) {
        return false;
      }
      const matchesACategory = selectedCategories.includes(experience.frontmatter.category);
      if(!matchesACategory) {
        return false;
      }
      return true;
    });
    const sortBy = sortBySelect.value;
    const orderBy = orderBySelect.value;
    const sortedExperiences = filteredExperiences.sort((experienceA, experienceB) => {
      const multiplier = orderBy === orderBys[0] ? 1 : -1;
      if(sortBy === sortBys[0]) {
        return multiplier * experienceA.frontmatter.title.localeCompare(experienceB.frontmatter.title);
      } else if(sortBy === sortBys[1]) {
        return multiplier * (new Date(experienceA.frontmatter.fromdate) - new Date(experienceB.frontmatter.fromdate));
      } else if(sortBy === sortBys[2]) {
        return multiplier * (new Date(experienceA.frontmatter.todate) - new Date(experienceB.frontmatter.todate));
      } else if(sortBy === sortBys[3]) {
        return multiplier * experienceA.frontmatter.category.localeCompare(experienceB.frontmatter.category);
      }
      return 0;
    });
    experiencesUl.innerHTML = `
      ${sortedExperiences.map((experience) => 
        `<li><a href="${experience.url}">${experience.frontmatter.title}</a></li>`).join('')}
    `;

    experiencesCountSpan.textContent = `${sortedExperiences.length}`;
  };

  const update = () => {
    updateURL();
    render();
  }

  const applyEventListeners = () => {
    showHiddenCheckbox.addEventListener('change', (e) => {
      update();
    });
    allCategoryCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => {
        update();
      });
    });
    sortBySelect.addEventListener('change', (e) => {
      update();
    });
    orderBySelect.addEventListener('change', (e) => {
      update();
    });
    showAllButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allCategoryCheckboxes.forEach(cb => cb.checked = true);
      sortBySelect.value=sortBys[0];
      orderBySelect.value=orderBys[0];
      update();
    });
    defaultButton.addEventListener('click', (e) => {
      applyDefaults();
      update();
    });
    competitionsButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allCategoryCheckboxes.forEach((checkbox) => {
        if(['In-Person Competition', 'Virtual Competition'].includes(checkbox.value)) {
          checkbox.checked = true;
        } else {
          checkbox.checked = false;
        }
      });
      update();
    });
    conferencesButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allCategoryCheckboxes.forEach((checkbox) => {
        if(['Conference'].includes(checkbox.value)) {
          checkbox.checked = true;
        } else {
          checkbox.checked = false;
        }
      });
      update();
    });
    roboticsButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allCategoryCheckboxes.forEach((checkbox) => {
        if(['Robotics'].includes(checkbox.value)) {
          checkbox.checked = true;
        } else {
          checkbox.checked = false;
        }
      });
      update();
    });
  };

  applyEventListeners();

  if(window.location.search) {
    loadFromURL();
  } else {
    applyDefaults();
  }

  update();
</script>

