---
import { type Project, sortBys, orderBys } from '../../types/project.ts';

import ProjectFilter from './ProjectFilter.astro';
import ProjectSort from './ProjectSort.astro';
import ProjectsList from './ProjectsList.astro';

interface Props {
  allProjects: Project[],
  allLanguages: string[],
  allAssociations: string[],
  allProgresses: string[],
}

const { allProjects, allLanguages, allAssociations, allProgresses } = Astro.props;
---
<h3>Projects</h3>
<ProjectFilter
  allLanguages={allLanguages}
  allAssociations={allAssociations}
  allProgresses={allProgresses}
/>
<ProjectSort
  sortBys={sortBys}
  orderBys={orderBys}
/>
<ProjectsList
  totalCount={allProjects.length}
/>
<script is:inline define:vars={{
  allProjects,
  allLanguages,
  allAssociations,
  allProgresses,
  sortBys,
  orderBys,
}}>
  // filter checkboxes
  const showHiddenCheckbox = document.getElementById('show-hidden-checkbox');
  const allLanguageCheckboxes = document.querySelectorAll('.filter-language-checkbox');
  const allAssociationCheckboxes = document.querySelectorAll('.filter-association-checkbox');
  const allProgressCheckboxes = document.querySelectorAll('.filter-progress-checkbox');

  // sort selects
  const sortBySelect = document.getElementById('sort-by-select');
  const orderBySelect = document.getElementById('order-by-select');

  // project list
  const projectsUl = document.getElementById('projects-ul');
  const projectCountSpan = document.getElementById('project-count-span');

  const applyDefaults = () => {
    showHiddenCheckbox.checked = false;
    allLanguageCheckboxes.forEach((checkbox) => checkbox.checked = true);
    allAssociationCheckboxes.forEach((checkbox) => checkbox.checked = true);
    allProgressCheckboxes.forEach((checkbox) => checkbox.checked = true);
    sortBySelect.value = sortBys[1]; // "Date"
    orderBySelect.value = orderBys[1]; // "Descending"
    projectCountSpan.textContent = `${allProjects.length}`;
  }

  const render = () => {
    let selectedLanguages = [];
    let selectedAssociations = [];
    let selectedProgresses = [];

    allLanguageCheckboxes.forEach((checkbox) => {
      if(checkbox.checked) {
        selectedLanguages = [...selectedLanguages, checkbox.value];
      }
    });

    allAssociationCheckboxes.forEach((checkbox) => {
      if(checkbox.checked) {
        selectedAssociations = [...selectedAssociations, checkbox.value];
      }
    });

    allProgressCheckboxes.forEach((checkbox) => {
      if(checkbox.checked) {
        selectedProgresses = [...selectedProgresses, checkbox.value];
      }
    });

    const filteredProjects = allProjects.filter((project) => {
      let shouldBeShown = false;
      let matchesALanguage = false;
      let matchesAnAssociation = false;
      let matchesAProgress = false;

      // 1. show hidden checkbox
      shouldBeShown = !project.frontmatter.hidden || showHiddenCheckbox.checked;
      if(!shouldBeShown) {
        return false;
      }

      // 2. language
      project.frontmatter.languages.forEach((language) => {
        if(selectedLanguages.includes(language)) {
          matchesALanguage = true;
          return;
        }
      });
      if(!matchesALanguage) {
        return false;
      }

      // 3. association
      matchesAnAssociation = selectedAssociations.includes(project.frontmatter.association);
      if(!matchesAnAssociation) {
        return false;
      }

      // 4. progress
      matchesAProgress = selectedProgresses.includes(project.frontmatter.progress);
      if(!matchesAProgress) {
        return false;
      }

      return true;
    });

    const sortBy = sortBySelect.value;
    const orderBy = orderBySelect.value;

    const sortedProjects = filteredProjects.sort((projectA, projectB) => {
      const multiplier = orderBy === orderBys[0] ? 1 : -1;
      if(sortBy === sortBys[0]) { // Title
        return multiplier * projectA.frontmatter.title.localeCompare(projectB.frontmatter.title);
      } else if(sortBy === sortBys[1]) { // Date
        return multiplier * (new Date(projectA.frontmatter.date) - new Date(projectB.frontmatter.date)); 
      } else if(sortBy === sortBys[2]) { // Association
        return multiplier * projectA.frontmatter.association.localeCompare(projectB.frontmatter.association);
      } else if(sortBy === sortBys[3]) { // Progress
        return multiplier * projectA.frontmatter.progress.localeCompare(projectB.frontmatter.progress);
      }
    });

    projectsUl.innerHTML = 
      `
  ${sortedProjects.map((project) => `
  <li>
    <a href="${project.url}">
      ${project.frontmatter.title}
    </a>
  </li>
  `).join('')}
  `;

    projectCountSpan.textContent = `${sortedProjects.length}`;
  }

  const applyEventListeners = () => {
    showHiddenCheckbox.addEventListener('change', (e) => render());
    allLanguageCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => render());
    });
    allAssociationCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => render());
    });
    allProgressCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => render());
    });
    sortBySelect.addEventListener('change', (e) => render());
    orderBySelect.addEventListener('change', (e) => render());
  }

  applyEventListeners();
  applyDefaults();
  render();
</script>
