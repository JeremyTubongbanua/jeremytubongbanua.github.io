---
import { type Project, sortBys, orderBys } from '../../types/project.ts';

import ProjectsQuickSelect from './ProjectsQuickSelect.astro';
import ProjectsFilter from './ProjectsFilter.astro';
import ProjectsSort from './ProjectsSort.astro';
import ProjectsList from './ProjectsList.astro';

interface Props {
  allProjects: Project[],
  allLanguages: string[],
  allAssociations: string[],
  allProgresses: string[],
}

const { allProjects, allLanguages, allAssociations, allProgresses } = Astro.props;
---
<h2>Projects</h2>
<ProjectsQuickSelect
/>
<ProjectsFilter
  allLanguages={allLanguages}
  allAssociations={allAssociations}
  allProgresses={allProgresses}
/>
<ProjectsSort
  sortBys={sortBys}
  orderBys={orderBys}
/>
<ProjectsList
  totalCount={allProjects.length}
/>
<script is:inline define:vars={{
  allProjects,
  allLanguages,
  allAssociations,
  allProgresses,
  sortBys,
  orderBys,
}}>
  // quick select
  const showAllButton = document.getElementById('projects-quick-select-show-all-button');
  const defaultButton = document.getElementById('projects-quick-select-default-button');
  const hobbyProjectsButton = document.getElementById('projects-quick-select-hobby-projects-button');
  const hackathonProjectsButton = document.getElementById('projects-quick-select-hackathon-projects-button');
  const schoolProjectsButton = document.getElementById('projects-quick-select-school-projects-button');
  const threeDPrintingProjectsButton = document.getElementById('projects-quick-select-3d-printing-projects-button');
  const cCppProjectsButton = document.getElementById('projects-quick-select-c-cpp-projects-button');

  // filter checkboxes
  const showHiddenCheckbox = document.getElementById('filter-show-hidden-checkbox');
  const allLanguageCheckboxes = document.querySelectorAll('.filter-language-checkbox');
  const allAssociationCheckboxes = document.querySelectorAll('.filter-association-checkbox');
  const allProgressCheckboxes = document.querySelectorAll('.filter-progress-checkbox');

  // sort selects
  const sortBySelect = document.getElementById('sort-sort-by-select');
  const orderBySelect = document.getElementById('sort-order-by-select');

  // project list
  const projectsUl = document.getElementById('projects-ul');
  const projectCountSpan = document.getElementById('project-count-span');

  const updateURL = () => {
    const params = new URLSearchParams();

    if(showHiddenCheckbox.checked) {
      params.append('showHidden', 'true');
    }

    const selectedLanguages = Array.from(allLanguageCheckboxes)
      .filter((checkbox) => checkbox.checked)
      .map((checkbox) => checkbox.value);
    if (selectedLanguages.length) {
      params.append('languages', selectedLanguages.join(','));
    }

    const selectedAssociations = Array.from(allAssociationCheckboxes)
      .filter((checkbox) => checkbox.checked)
      .map((checkbox) => checkbox.value);
    if (selectedAssociations.length) {
      params.append('associations', selectedAssociations.join(','));
    }

    const selectedProgresses = Array.from(allProgressCheckboxes)
      .filter((checkbox) => checkbox.checked)
      .map((checkbox) => checkbox.value);
    if (selectedProgresses.length) {
      params.append('progress', selectedProgresses.join(','));
    }

    params.append('sortBy', sortBySelect.value);
    params.append('orderBy', orderBySelect.value);

    const newURL = params.toString()
      ? `${window.location.pathname}?${params.toString()}`
      : window.location.pathname;

    window.history.replaceState({}, '', newURL);
  }

  const loadFromURL = () => {
    const params = new URLSearchParams(window.location.search);

    showHiddenCheckbox.checked = params.get('showHidden') === 'true';

    const urlLanguages = params.get('languages')?.split(',').filter(Boolean) || [];
    if (urlLanguages.length > 0) {
      allLanguageCheckboxes.forEach((checkbox) => {
        checkbox.checked = urlLanguages.includes(checkbox.value);
      });
    } else {
      allLanguageCheckboxes.forEach((checkbox) => checkbox.checked = true);
    }

    const urlAssociations = params.get('associations')?.split(',').filter(Boolean) || [];
    if (urlAssociations.length > 0) {
      allAssociationCheckboxes.forEach((checkbox) => {
        checkbox.checked = urlAssociations.includes(checkbox.value);
      });
    } else {
      allAssociationCheckboxes.forEach((checkbox) => checkbox.checked = true);
    }

    const urlProgresses = params.get('progress')?.split(',').filter(Boolean) || [];
    if (urlProgresses.length > 0) {
      allProgressCheckboxes.forEach((checkbox) => {
        checkbox.checked = urlProgresses.includes(checkbox.value);
      });
    } else {
      allProgressCheckboxes.forEach((checkbox) => checkbox.checked = true);
    }

    // Load sort options
    sortBySelect.value = params.get('sortBy') || sortBys[1]; // "Date"
    orderBySelect.value = params.get('orderBy') || orderBys[1]; // "Descending"

    projectCountSpan.textContent = `${allProjects.length}`;
  }

  const applyDefaults = () => {
    showHiddenCheckbox.checked = false;
    allLanguageCheckboxes.forEach((checkbox) => checkbox.checked = true);
    allAssociationCheckboxes.forEach((checkbox) => checkbox.checked = true);
    allProgressCheckboxes.forEach((checkbox) => checkbox.checked = true);
    sortBySelect.value = sortBys[1]; // "Date"
    orderBySelect.value = orderBys[1]; // "Descending"
    projectCountSpan.textContent = `${allProjects.length}`;
  }

  const getProcessedProjects = () => {
    const selectedLanguages = Array.from(allLanguageCheckboxes).filter((checkbox) => checkbox.checked).map((checkbox) => checkbox.value);
    const selectedAssociations = Array.from(allAssociationCheckboxes).filter((checkbox) => checkbox.checked).map((checkbox) => checkbox.value);
    const selectedProgresses = Array.from(allProgressCheckboxes).filter((checkbox) => checkbox.checked).map((checkbox) => checkbox.value);

    const filteredProjects = allProjects.filter((project) => {
      let shouldBeShown = false;
      let matchesALanguage = false;
      let matchesAnAssociation = false;
      let matchesAProgress = false;

      // 1. show hidden checkbox
      shouldBeShown = !project.frontmatter.hidden || showHiddenCheckbox.checked;
      if(!shouldBeShown) {
        return false;
      }

      // 2. language
      project.frontmatter.languages.forEach((language) => {
        if(selectedLanguages.includes(language)) {
          matchesALanguage = true;
          return;
        }
      });
      if(!matchesALanguage) {
        return false;
      }

      // 3. association
      matchesAnAssociation = selectedAssociations.includes(project.frontmatter.association);
      if(!matchesAnAssociation) {
        return false;
      }

      // 4. progress
      matchesAProgress = selectedProgresses.includes(project.frontmatter.progress);
      if(!matchesAProgress) {
        return false;
      }

      return true;
    });

    const sortBy = sortBySelect.value;
    const orderBy = orderBySelect.value;

    const sortedProjects = filteredProjects.sort((projectA, projectB) => {
      const multiplier = orderBy === orderBys[0] ? 1 : -1;
      if(sortBy === sortBys[0]) { // Title
        return multiplier * projectA.frontmatter.title.localeCompare(projectB.frontmatter.title);
      } else if(sortBy === sortBys[1]) { // Date
        return multiplier * (new Date(projectA.frontmatter.date) - new Date(projectB.frontmatter.date)); 
      } else if(sortBy === sortBys[2]) { // Association
        return multiplier * projectA.frontmatter.association.localeCompare(projectB.frontmatter.association);
      } else if(sortBy === sortBys[3]) { // Progress
        return multiplier * projectA.frontmatter.progress.localeCompare(projectB.frontmatter.progress);
      }
    });

    return sortedProjects;
  }

  const render = () => {
    const processedProjects = getProcessedProjects();

    projectsUl.innerHTML = 
      `
        ${processedProjects.map((project) => `
        <li>
          <a href="${project.url}">
            ${project.frontmatter.title}
          </a>
        </li>
        `).join('')}
      `;

    projectCountSpan.textContent = `${processedProjects.length}`;
  }

  const update = () => {
    render();
    updateURL();
  }

  const applyEventListeners = () => {
    showHiddenCheckbox.addEventListener('change', (e) => {
      update();
    });
    allLanguageCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => {
        update();
      });
    });
    allAssociationCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => {
        update();
      });
    });
    allProgressCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => {
        update();
      });
    });
    sortBySelect.addEventListener('change', (e) => { 
      update();
    });
    orderBySelect.addEventListener('change', (e) => {
      update();
    });
    showAllButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allLanguageCheckboxes.forEach((checkbox) => checkbox.checked = true);
      allAssociationCheckboxes.forEach((checkbox) => checkbox.checked = true);
      allProgressCheckboxes.forEach((checkbox) => checkbox.checked = true);
      sortBySelect.value = sortBys[0];
      orderBySelect.value = orderBys[0];
      update();
    });
    defaultButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = false;
      allLanguageCheckboxes.forEach((checkbox) => checkbox.checked = true);
      allAssociationCheckboxes.forEach((checkbox) => checkbox.checked = true);
      allProgressCheckboxes.forEach((checkbox) => checkbox.checked = true);
      sortBySelect.value = sortBys[1];
      orderBySelect.value = orderBys[1];
      update();
    });
    hobbyProjectsButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allLanguageCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      allAssociationCheckboxes.forEach((checkbox) => {
        if(['Hobby'].includes(checkbox.value)) {
          checkbox.checked = true;
        } else {
          checkbox.checked = false;
        }
      });
      allProgressCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      sortBySelect.value = sortBys[1];
      orderBySelect.value = orderBys[1];
      update();
    });
    hackathonProjectsButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allLanguageCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      allAssociationCheckboxes.forEach((checkbox) => {
        if(['Hackathon'].includes(checkbox.value)) {
          checkbox.checked = true;
        } else {
          checkbox.checked = false;
        }
      });
      allProgressCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      sortBySelect.value = sortBys[1];
      orderBySelect.value = orderBys[1];
      update();
    });
    schoolProjectsButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allLanguageCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      allAssociationCheckboxes.forEach((checkbox) => {
        if(['School'].includes(checkbox.value)) {
          checkbox.checked = true;
        } else {
          checkbox.checked = false;
        }
      });
      allProgressCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      sortBySelect.value = sortBys[1];
      orderBySelect.value = orderBys[1];
      update();
    });
    threeDPrintingProjectsButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allLanguageCheckboxes.forEach((checkbox) => {
        if(['3D Printing'].includes(checkbox.value)) {
          checkbox.checked = true;
        } else {
          checkbox.checked = false;
        }
      });
      allAssociationCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      allProgressCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      update();
    });
    cCppProjectsButton.addEventListener('click', (e) => {
      showHiddenCheckbox.checked = true;
      allLanguageCheckboxes.forEach((checkbox) => {
        if(['C', 'C++'].includes(checkbox.value)) {
          checkbox.checked = true;
        } else {
          checkbox.checked = false;
        }
      });
      allAssociationCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      allProgressCheckboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      update();
    });
  }

  applyEventListeners();

  if (window.location.search) {
    loadFromURL();
  } else {
    applyDefaults();
  }

  updateURL();
  render();
</script>
