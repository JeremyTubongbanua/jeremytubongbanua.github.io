---
import BaseLayout from '../../layouts/BaseLayout.astro';
const allProjects =
Object.values(import.meta.glob('../projects/**/index.md', {eager: true}));

let languages = ['No Programming Language'];
allProjects.forEach((project) => {
  let langs = project.frontmatter.languages;
  langs.forEach((lang) => {
    if(!languages.includes(lang)) {
      languages = [...languages, lang];
    }
  });
});

let progresses: any = [];
allProjects.forEach((project) => {
  if(!progresses.includes(project.frontmatter.progress)) {
    progresses = [...progresses, project.frontmatter.progress];
  }
});

let associations: any = [];
allProjects.forEach((project) => {
  if(!associations.includes(project.frontmatter.association)) {
    associations = [...associations, project.frontmatter.association];
  }
});

const bys = ['Date', 'Title', 'Association', 'Progress'];
const orders = ['Ascending', 'Descending'];
/**
  * project.frontmatter.
  *   title
  *   subtitle
  *   description
  *   date
  *   languages: []
  *   progress: {In-Progress, Finished}
  *   association: {Atsign, Hobby, Hackathon}
  *   layout
  *   hidden: {true, false}
  */
---
<BaseLayout pageTitle="Projects">
  <h2>Projects</h2>

  <div class="project-filter">
    <fieldset>
      <legend>Filter</legend>
      <button id="show-all">Show All</button>
      <div>
        <label>
          Show Hidden:
          <input id="filter-show-hidden" type="checkbox" /> 
        </label>
      </div>
      Programming Language:
      {languages.map((language: any) => (
      <label>
        <input type="checkbox" class="filter-language" value={language} checked />
        {language}
      </label>
      ))}
      <br/>
      Progress:
      {progresses.map((progress: any) => (
      <label>
        <input type="checkbox" class="filter-progress" value={progress} checked />
        {progress}
      </label>
      ))}
      <br/>
      Association:
      {associations.map((association: any) => (
      <label>
        <input type="checkbox" class="filter-association" value={association} checked />
        {association}
      </label>
      ))}
    </fieldset>
  </div>

  <fieldset id="project-sort">
    <legend>Sort</legend>
    <label>
      Sort By:
      <select id="sort-by">
        {bys.map((by) => (
        <option value={by} selected={by === 'Title'}>{by}</option>
        ))}
      </select>
    </label>
    <label>
      Order By:
      <select id="sort-order">
        {orders.map((order) => (
        <option value={order} selected={order === 'Ascending'}>{order}</option>
        ))}
      </select>
    </label>
  </fieldset>

  <div id="project-list">
    <h3>Viewing: <span id="project-count">0</span> projects out of {allProjects.length}</h3>
    <ul id="projects-ul"></ul>
  </div>

  <script is:inline define:vars={{ allProjects, languages, progresses, associations, bys, orders }}>
const state = {
  filter: {
    languages: [...languages],
    progresses: [...progresses],
    associations: [...associations],
    showHidden: false,
  },
  sort: {
    by: bys[1], // 'Title'
    order: orders[0], // 'Ascending'
  }
};

const languageCheckboxes = document.querySelectorAll('.filter-language');
const progressCheckboxes = document.querySelectorAll('.filter-progress');
const associationCheckboxes = document.querySelectorAll('.filter-association');
const showHiddenCheckbox = document.getElementById('filter-show-hidden');
const sortBySelect = document.getElementById('sort-by');
const sortOrderSelect = document.getElementById('sort-order');
const projectsUl = document.getElementById('projects-ul');
const projectCount = document.getElementById('project-count');
const showAllBtn = document.getElementById('show-all');

const processProjects = () => {
  const filteredProjects = allProjects.filter((project) => {
    const shouldBeShown = !project.frontmatter.hidden || state.filter.showHidden;
    const matchesLanguages = project.frontmatter.languages.length === 0
      ? state.filter.languages.includes('No Programming Language')
      : project.frontmatter.languages.some((language) => state.filter.languages.includes(language));
    const matchesProgress = state.filter.progresses.includes(project.frontmatter.progress);
    const matchesAssociation = state.filter.associations.includes(project.frontmatter.association);
    return shouldBeShown && matchesLanguages && matchesProgress && matchesAssociation;
  });

  const sortedProjects = [...filteredProjects].sort((projectA, projectB) => {
    const multiplier = state.sort.order === orders[0] ? 1 : -1;
    let value = 0;
    if (state.sort.by === bys[0]) {
      value = multiplier * (new Date(projectA.frontmatter.date) - new Date(projectB.frontmatter.date));
    } else if (state.sort.by === bys[1]) {
      value = multiplier * projectA.frontmatter.title.localeCompare(projectB.frontmatter.title);
    } else if (state.sort.by === bys[2]) {
      value = multiplier * projectA.frontmatter.association.localeCompare(projectB.frontmatter.association);
    } else if (state.sort.by === bys[3]) {
      value = multiplier * projectA.frontmatter.progress.localeCompare(projectB.frontmatter.progress);
    }
    return value;
  });

  return sortedProjects;
}

const updateURL = () => {
  const params = new URLSearchParams();

  params.set('languages', state.filter.languages.join(','));
  params.set('progresses', state.filter.progresses.join(','));
  params.set('associations', state.filter.associations.join(','));
  params.set('showHidden', state.filter.showHidden);
  params.set('by', state.sort.by);
  params.set('order', state.sort.order);

  window.history.replaceState({}, '', `?${params.toString()}`);
}

const loadStateFromURL = () => {
  const params = new URLSearchParams(window.location.search);

  if(params.has('languages')) {
    state.filter.languages = params.get('languages').split(',').filter(Boolean);
  }

  if(params.has('progresses')) {
    state.filter.progresses = params.get('progresses').split(',').filter(Boolean);
  }

  if(params.has('associations')) {
    state.filter.associations = params.get('associations').split(',').filter(Boolean);
  }

  if(params.has('showHidden')) {
    state.filter.showHidden = params.get('showHidden') === 'true';
  }

  if(params.has('by')) {
    state.sort.by = params.get('by');
  }

  if(params.has('order')) {
    state.sort.order = params.get('order');
  }

  languageCheckboxes.forEach((cb) => cb.checked = state.filter.languages.includes(cb.value));
  progressCheckboxes.forEach((cb) => cb.checked = state.filter.progresses.includes(cb.value));
  associationCheckboxes.forEach((cb) => cb.checked = state.filter.associations.includes(cb.value));
  showHiddenCheckbox.checked = state.filter.showHidden;

  sortBySelect.value = state.sort.by;
  sortOrderSelect.value = state.sort.order;
}

const render = () => {
  const processedProjects = processProjects();

  projectCount.textContent = processedProjects.length;

  projectsUl.innerHTML = processedProjects.map((project) => `
<li>
<a href="${project.url}">
${project.frontmatter.title}
</a>
</li>
`).join('');
}

languageCheckboxes.forEach((checkbox) => {
  checkbox.addEventListener('change', (e) => {
    const language = e.target.value;
    if (e.target.checked) {
      state.filter.languages = [...state.filter.languages, language];
    } else {
      state.filter.languages = state.filter.languages.filter((l) => l !== language);
    }
    updateURL();
    render();
  });
});

progressCheckboxes.forEach((checkbox) => {
  checkbox.addEventListener('change', (e) => {
    const progress = e.target.value;
    if (e.target.checked) {
      state.filter.progresses = [...state.filter.progresses, progress];
    } else {
      state.filter.progresses = state.filter.progresses.filter((p) => p !== progress);
    }
    updateURL();
    render();
  });
});

associationCheckboxes.forEach((checkbox) => {
  checkbox.addEventListener('change', (e) => {
    const association = e.target.value;
    if (e.target.checked) {
      state.filter.associations = [...state.filter.associations, association];
    } else {
      state.filter.associations = state.filter.associations.filter((a) => a !== association);
    }
    updateURL();
    render();
  });
});

showHiddenCheckbox.addEventListener('change', (e) => {
  const isChecked = e.target.checked;
  if(isChecked) {
    // was just turned on, show hidden
    state.filter.showHidden = true;
  } else {
    state.filter.showHidden = false;
  }
  updateURL();
  render();
});

sortBySelect.addEventListener('change', (e) => {
  state.sort.by = e.target.value;
  updateURL();
  render();
});

sortOrderSelect.addEventListener('change', (e) => {
  state.sort.order = e.target.value;
  updateURL();
  render();
});

showAllBtn.addEventListener('click', () => {
  state.filter.languages = [...languages];
  state.filter.progresses = [...progresses];
  state.filter.associations = [...associations];
  state.filter.showHidden = true;

  showHiddenCheckbox.checked = true;
  languageCheckboxes.forEach((cb) => cb.checked = true);
  progressCheckboxes.forEach((cb) => cb.checked = true);
  associationCheckboxes.forEach((cb) => cb.checked = true);

  updateURL();
  render();
});

loadStateFromURL();
render();
  </script>
</BaseLayout>


